(function(a){if(document.selection&&document.selection.createRange){a.fn.extend({focus:(function(b){return function(){var e,d,c;if(arguments.length===0){e=a(window);d={top:e.scrollTop(),left:e.scrollLeft()};c=b.apply(this,arguments);window.scrollTo(d.top,d.left);return c}return b.apply(this,arguments)}}(a.fn.focus))})}a.fn.textSelection=function(d,j){var i,b,g,e,c;function f(l){if(l.nodeName.toLowerCase()==="input"){return l.createTextRange()}else{var k=document.body.createTextRange();k.moveToElementText(l);return k}}function h(k){if(k.setActive){k.setActive()}else{a(k).focus()}}i={getContents:function(){return this.val()},getSelection:function(){var k,l,m=this.get(0);if(a(m).is(":hidden")){k=""}else{if(document.selection&&document.selection.createRange){h(m);l=document.selection.createRange();k=l.text}else{if(m.selectionStart||m.selectionStart===0){k=m.value.substring(m.selectionStart,m.selectionEnd)}}}return k},encapsulateSelection:function(k){return this.each(function(){var n,o,l,q,r,x,w,t,m,p=k.pre,v=k.post;function s(){if(!n){n=k.peri;q=true}else{if(k.replace){n=k.peri}else{while(n.charAt(n.length-1)===" "){n=n.substring(0,n.length-1);v+=" "}while(n.charAt(0)===" "){n=n.substring(1,n.length);p=" "+p}}}}function u(D,C,z){var y,B="",A=D.split("\n");for(y=0;y<A.length;y++){B+=C+A[y]+z;if(y!==A.length-1){B+="\n"}}return B}q=false;if(this.style.display==="none"){}else{if(document.selection&&document.selection.createRange){h(this);if(b){b.fn.restoreCursorAndScrollTop()}if(k.selectionStart!==undefined){a(this).textSelection("setSelection",{start:k.selectionStart,end:k.selectionEnd})}n=a(this).textSelection("getSelection");o=this.scrollTop;r=document.selection.createRange();s();l=p+n+v;if(k.splitlines){l=u(n,p,v)}if(k.ownline&&r.moveStart){x=document.selection.createRange();x.collapse();x.moveStart("character",-1);if(x.text!=="\r"&&x.text!=="\n"&&x.text!==""){l="\n"+l;p+="\n"}w=document.selection.createRange();w.collapse(false);w.moveEnd("character",1);if(w.text!=="\r"&&w.text!=="\n"&&w.text!==""){l+="\n";v+="\n"}}r.text=l;if(q&&k.selectPeri&&r.moveStart){r.moveStart("character",-v.length-n.length);r.moveEnd("character",-v.length)}r.select();this.scrollTop=o}else{if(this.selectionStart||this.selectionStart===0){a(this).focus();if(k.selectionStart!==undefined){a(this).textSelection("setSelection",{start:k.selectionStart,end:k.selectionEnd})}n=a(this).textSelection("getSelection");t=this.selectionStart;m=this.selectionEnd;o=this.scrollTop;s();if(k.selectionStart!==undefined&&m-t!==k.selectionEnd-k.selectionStart){t=k.selectionStart}l=p+n+v;if(k.splitlines){l=u(n,p,v)}if(k.ownline){if(t!==0&&this.value.charAt(t-1)!=="\n"&&this.value.charAt(t-1)!=="\r"){l="\n"+l;p+="\n"}if(this.value.charAt(m)!=="\n"&&this.value.charAt(m)!=="\r"){l+="\n";v+="\n"}}this.value=this.value.substring(0,t)+l+this.value.substring(m,this.value.length);this.scrollTop=o;if(window.opera){p=p.replace(/\r?\n/g,"\r\n");n=n.replace(/\r?\n/g,"\r\n");v=v.replace(/\r?\n/g,"\r\n")}if(q&&k.selectPeri&&!k.splitlines){this.selectionStart=t+p.length;this.selectionEnd=t+p.length+n.length}else{this.selectionStart=t+l.length;this.selectionEnd=this.selectionStart}}}}a(this).trigger("encapsulateSelection",[k.pre,k.peri,k.post,k.ownline,k.replace,k.spitlines])})},getCaretPosition:function(k){function l(s){var r=0,m=0,n,q,y,z,t,x,p,o,w,v,A,u;if(document.selection&&document.selection.createRange){h(s);p=false;o=false;w=false;v=document.selection.createRange().duplicate();A=f(s),A.setEndPoint("EndToStart",v);u=f(s);u.setEndPoint("StartToEnd",v);n=q=A.text;y=z=v.text;t=x=u.text;do{if(!p){if(A.compareEndPoints("StartToEnd",A)===0){p=true}else{A.moveEnd("character",-1);if(A.text===n){q+="\r\n"}else{p=true}}}if(!o){if(v.compareEndPoints("StartToEnd",v)===0){o=true}else{v.moveEnd("character",-1);if(v.text===y){z+="\r\n"}else{o=true}}}if(!w){if(u.compareEndPoints("StartToEnd",u)===0){w=true}else{u.moveEnd("character",-1);if(u.text===t){x+="\r\n"}else{w=true}}}}while((!p||!o||!w));r=q.replace(/\r\n/g,"\n").length;m=r+z.replace(/\r\n/g,"\n").length}else{if(s.selectionStart||s.selectionStart===0){r=s.selectionStart;m=s.selectionEnd}}return k.startAndEnd?[r,m]:r}return l(this.get(0))},setSelection:function(k){return this.each(function(){var m,n,l;if(a(this).is(":hidden")){}else{if(this.selectionStart||this.selectionStart===0){if(k.start>this.selectionEnd){this.selectionEnd=k.end;this.selectionStart=k.start}else{this.selectionStart=k.start;this.selectionEnd=k.end}}else{if(document.body.createTextRange){m=f(this);n=this.value.length;l=this.value.match(/\n/g);if(l){n=n-l.length}m.moveStart("character",k.start);m.moveEnd("character",-n+k.end);try{m.select()}catch(o){}}}}})},scrollToCaretPosition:function(k){function l(n){return Math.floor(n.scrollWidth/(a.client.profile().platform==="linux"?7:8))}function m(r){var q,p,v,u=r.value.replace(/\r/g,""),t=a(r).textSelection("getCaretPosition"),n=l(r),w=0,o=0,s=0;for(q=0;q<t;q++){o++;if(u.charAt(q)===" "){s=o}else{if(u.charAt(q)==="\n"){s=0;o=0;w++}}if(o>n){if(s>0){o=o-s;s=0;w++}}}v=0;for(p=t;p<t+n;p++){if(u.charAt(p)===" "||u.charAt(p)==="\n"||t===u.length){v=p;break}}if(v>n&&t<=n){o=t-s;w++}return(a.client.profile().platform==="mac"?13:(a.client.profile().platform==="linux"?15:16))*w}return this.each(function(){var n,p,o,r,q;if(a(this).is(":hidden")){}else{if(this.selectionStart||this.selectionStart===0){n=m(this);if(k.force||n<a(this).scrollTop()||n>a(this).scrollTop()+a(this).height()){a(this).scrollTop(n)}}else{if(document.selection&&document.selection.createRange){p=document.body.createTextRange();o=document.selection.createRange();r=a(this).textSelection("getCaretPosition");q=this.scrollTop;p.moveToElementText(this);p.collapse();p.move("character",r+1);p.select();if(this.scrollTop!==q){this.scrollTop+=p.offsetTop}else{if(k.force){p.move("character",-1);p.select()}}o.select()}}}a(this).trigger("scrollToPosition")})}};switch(d){case"encapsulateSelection":j=a.extend({pre:"",peri:"",post:"",ownline:false,replace:false,selectPeri:true,splitlines:false,selectionStart:undefined,selectionEnd:undefined},j);break;case"getCaretPosition":j=a.extend({startAndEnd:false},j);break;case"setSelection":j=a.extend({start:undefined,end:undefined,startContainer:undefined,endContainer:undefined},j);if(j.end===undefined){j.end=j.start}if(j.endContainer===undefined){j.endContainer=j.startContainer}break;case"scrollToCaretPosition":j=a.extend({force:false},j);break}b=a(this).data("wikiEditor-context");g=b!==undefined&&b&&b.$iframe!==undefined;e=false;if(g&&b.savedSelection!==null){b.fn.restoreSelection();e=true}c=(g?b.fn:i)[d].call(this,j);if(g&&e){b.fn.saveSelection()}return c}}(jQuery));